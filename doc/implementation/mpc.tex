\section{MPC}

The task of the MPC part of the implementation is to supply the ACADO implementation with the information needed to perform the optimization, and also control the optimization algorithm so that the correct horizon is calculated, as well as storing the results in the correct order. The pseudocode for the MPC implementation is shown in algorithm \ref{alg:mpc} and \ref{alg:genHor}.

\begin{algorithm}
\caption{Offline Intervalwise MPC Algorithm}
\label{alg:mpc}
\begin{algorithmic}
\Procedure{MPC}{}
	\State $\textit{path} \gets \text{path from file}$
	\State $\textit{timestep} \gets \text{duration of timestep [s]}$
	\State $\textit{horizonlen} \gets \text{number of } \textit{timestep} \text{ in horizon}$
	\State $\textit{intervallen} \gets \text{number of } \textit{timestep} \text{ in interval}$
	\State $\textit{intervals} \gets \text{number of intervals needed to cover } \textit{path}$
	\State $\textit{x}_0 \gets \text{initial values of states}$
	\State $\textit{u}_0 \gets \text{initial values of control states}$
	\State $\Delta\textit{u}_0 \gets \text{inital values of control rates}$
	\State $\textit{results[]} \gets \text{empty list to store result from optimization}$
	\For{each \textit{interval}}
		\State $\mathbf{c}^n \gets \text{calculate camera centre position using equation } \ref{eq:camera_position_ned}$
		\State $\textit{trajectory} \gets$ \Call{GenerateHorizon}{\textit{path, timestep, horizonlen,  } $\mathbf{c}^n$}
		\State Solve optimization with initial states $x_0$, $u_0$, $\Delta u_0$ for current \textit{horizon}
		\State $\textit{x}_0 \gets \text{ last } \textit{x} \text{ value in the } \textit{interval}$
		\State $\textit{u}_0 \gets \text{ last } \textit{u} \text{ value in the } \textit{interval}$
		\State $\Delta\textit{u}_0 \gets \text{ last } \Delta\textit{u} \text{ value in the } \textit{interval}$
		\State $\textit{result[]} \gets$ the first \textit{intervallen} number of \textit{timesteps} from \textit{horizon}
	\EndFor
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Generate horizon}
\label{alg:genHor}
\begin{algorithmic}
\Procedure{GenerateHorizon}{\textit{\textit{path, timestep, horizonlen, } $\mathbf{c}^n$}}
	\State $\textit{distance} \gets \text{distance travelled during one timestep}$
	\State \textit{pos} $\gets$ find the point in \textit{path} that is closes to current camera position $\mathbf{c}^n$
	\State $\textit{trajectory[]} \gets \text{empty list to store the generated trajectory}$
	\For{each \textit{timestep} in \textit{horizonlen}}
		\State Find point \textit{$pos_{temp}$} on \textit{path} with the given \textit{distance} away from current \textit{pos}
		\State $\textit{trajectory[]} \gets pos_{temp}$
		\State $pos \gets pos_{temp}$
	\EndFor
	\Return \textit{trajectory}
\EndProcedure
\end{algorithmic}
\end{algorithm}


\subsection{Generating the Trajectory}

The ground path that is to observed is assumed to be \textit{time independent}, meaning that it does not matter when a section of the path is captured by the sensor. However, the function that minimizes a least-squares objective function that is provided with the ACADO toolkit requires that the path is given as values with associated time points.

In order to meet this requirement a time dependent path will be generated at the beginning of every iteration of the MPC. This will be done by making the assumption that the UAV will maintain its reference speed throghout the horizon. With this assumption it is simple to calculate the distance the UAV will travel between every timestep, and based on this distance the desired position for the UAV at the next timestep may be calculated. Since the horizon is in the order of a few seconds and the predicted path is updated every iteration, this assumption will not lead to big errors. The principle behind the calculation is shown in figure \ref{fig:predict_path}.

\begin{figure}
	\import{/}{predict_path_fig.tex}
	\caption{The trajectory is calculated by assuming that the aircraft will travel at a constant speed so that each point can be spaced by the distance the aircraft travels during one timestep.}
	\label{fig:predict_path}
\end{figure}