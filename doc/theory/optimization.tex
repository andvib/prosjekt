\section{Optimization}
\label{ch:optimization}

In this chapter the methods and equations used for the optimization problem will be given. The goal of the optimization problem is to minimize the distance between the centre of the camera footprint and the path that is to be observed. The optimization problem will be given as an offline Model Predictive Control (MPC) problem, that includes the entire UAV model as constraints.


\subsection{MPC Method}

Model Predictive Control (MPC) is a control method that uses knowledge about the process to calculate the control signals. By calculating the future states of the process over a prediction horizon it calculates the control signals that will cause the process to follow a reference trajectory in the best way possible. The MPC strategy can be broken down into three tasks \cite{mpcCAMACHO}:

\begin{enumerate}
	\item Predict the future outputs of the process for the given prediction horizon using past inputs to the process and the past measured states of the process, and by using the future control signals.
	\item Optimize an objective function in order to determine the future control signals that follows a given reference trajectory as closely as possible.
	\item Apply the optimal control signals to the process, and measure the resulting output so that it may be used to calculate the next prediction horizon in the first task.
\end{enumerate}

In short MPC problems are made up of three elements \cite{mpcCAMACHO}: Prediction model, objective function and the control law. The prediction model represents the model of the process that is to be controlled, and will in this case consist of the differential equations for the states of the UAV. The objective function is the function that is to be minimized by the optimization algorithm, in this case this will be the distance from the camera centre point to the desired ground path together with some of the UAV states that will give a stable flight. The objective function represents the reference trajectory that the UAV is to follow. The control law introduces constraints on the problem, reducing the number of feasible solutions. This constraints can be put on either the states or the control inputs for the UAV.

A mathematical formulation of the three elements that make up the optimization problem is shown in \ref{eq:optimization_formulation} \cite{nocedalOPTIMIZATION}. $f(x)$ represents the objective function that is subject to equality and inequality constraints respectively. The equality constraints are used to represent the UAV model, while the inequality constraints represent the constraints used for the control law. The control law may also consist of equality constraints.

\begin{equation}
	\label{eq:optimization_formulation}
	\begin{array}{rrclcl}
		\displaystyle \min_{x \in R^n} & \multicolumn{3}{l}{f(x)} \\
		\textrm{s.t}
		& c_i(x) = 0, i \in \epsilon, \\
		& c_i(x) \geq 0, i \in I.
	\end{array}
\end{equation}

\subsection{Least-Squares Problem}

\begin{equation}
	\label{eq:lsq}
	f(x) = \frac{1}{2} \sum_{j=1}^m r_j^2(x)
\end{equation}

In many applications the objective functions is formulated as a least-square (LSQ) problem and the general form of an LSQ is shown in equation \ref{eq:lsq} \cite{nocedalOPTIMIZATION}. This method is often used when problem involves measurements that is expected to follow a model that is known in advance. By formulating this as a LSQ problem and minmizing the resulting optimization problem, it is possible to find parameters that minimizes the difference between the model and the measurements. 

The matching of measurements and a model relates to this task because the optimization problem will be given a path, and needs to find the best control inputs in order for the camera centre point to stay as close to this path as possible. However, since the path is prametrized and the position of the UAV on the path is not related to the path by time, there might be errors in calculating the difference between the path and the UAV because the UAV postion and the closest parametrized point may not be aligned/orthogonal. 

To solve this problem a method called 'orthogonal distance regression' may be used \cite{nocedalOPTIMIZATION}. This method adds a perturbation to one of the coordinates on the path and a perturbation to the UAV position. By minimizing these perturbations, the shortest distance from the path that is also orthogonal to the path can be found. How this relates to equation \ref{eq:lsq} is shown in equation \ref{eq:odr}, and a visual representation is shown in figure \ref{fig:ord}. The equations for the distance between the camera centre point and the path that it is to follow will be derived in the next subsection.
% This paragraph REALLY needs to be rewritten

\begin{equation}
	\label{eq:odr}
	\min_{x, \delta} F(x,\delta) = \frac{1}{2}\sum_{j=1}^{2m}r_j^2(x,\delta)
\end{equation}


\subsection{Problem Definition}

For the problem definition the 12 DOF UAV model presented by Beard \& McLain \cite{uavBEARD} will be implemented. This means that the optimization vector will consist of 12 states, and there will be 4 control signals:

\begin{equation}
	\mathbf{x} =
	\begin{bmatrix}
		p_N \\ p_E \\ p_D \\
		u \\ v \\ w \\
		\phi \\ \theta \\ \psi \\
		p \\ q \\ r
	\end{bmatrix}
	, \hspace{5pt} \mathbf{u} =
	\begin{bmatrix}
		\delta_e \\ \delta_a \\ \delta_r \\ \delta_t
	\end{bmatrix}.
\end{equation}


\subsubsection{Prediction Model}

The prediction model relates to the equality constraints of equation \ref{eq:optimization_formulation} in the form of differential equations. Based on the control inputs and current states, $\mathbf{\dot{x}}$ is calculated by the differential equation. The attitude angles will be expressed in Euler angles. Even though quaternions offer more efficient computations and no gimbal lock \cite{uavBEARD}, this optimization will be run on an offboard computer/offline so that computation capacity is not a big issue and the UAV is not going to undergo any extreme maneuvers so that a gimbal lock should never occur.


\subsubsection{Objective Function}


\subsubsection{Control Law}

The only physical constraints in this optimization problem is constraints on the control inputs, as shown in equation \ref{eq:control_constraint}. This inequality constraint ensures that the control surfaces of the UAV simulated in the optimization do not excede what the UAV is physically capable of.

\begin{equation}
	\label{eq:control_constraint}
	\mathbf{u}^{low} \leq \mathbf{u} \leq \mathbf{u}^{high}
\end{equation}
% Should maybe come from a source? Different formulation?